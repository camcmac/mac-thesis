---
#########################################
# options for knitting a single chapter #
#########################################
output:
  bookdown::pdf_document2:
    template: templates/brief_template.tex
    citation_package: biblatex
  bookdown::html_document2: default
  bookdown::word_document2: default
documentclass: book
bibliography: [bibliography/references.bib]
#chapter level bibliography
#bibliography: [bibliography/synth-ref.bib]
params:
  width: 70%
  in_loc: '~/PhD/thesis_git/mac-thesis/data/biosec/'
  fig_out: '~/PhD/thesis_git/mac-thesis/figures/chapter-figs/database'
---

# Organisms associated with anthropogenic marine debris reported in the scientific literature globally from 1990 to 2019  
\chaptermark{OAAMD Database}

```{r setup, include = F, }
library(tidyverse)
library(janitor)
library(purrr)
library(kableExtra)
library(ggOceanMaps)
```


```{r load files, include = F}

pull_dfs <- c("organisms", "papers", "spatial", "taxonomy")
file_type <- c(".csv")

list_dfs <- pull_dfs %>%
  map(~ read.csv(paste0(params$in_loc, ., file_type), encoding = "UTF-8")) %>%
  map(~ na_if(., "")) %>%
  map(~ remove_empty(., which = c("rows", "cols"))) %>%
  map(~ janitor::clean_names(.)) %>%
  map(~ rename_with(., ~str_remove(., "x_u_feff_")))
  
names(list_dfs) <- pull_dfs

list2env(list_dfs, envir = globalenv())

```

```{r prep data, include = F}

organisms_clean <- organisms %>%
  select(-rank) %>%
  mutate(scientific_name = fct_recode(as.factor(scientific_name),
                                      Actiniaria = "Actinaria",
                                      Amoebophrya = "Amoebophyra"))
#names need further cleaning

df_orgs <- left_join(organisms_clean, taxonomy)

spatial <- spatial %>%
  mutate(lat = as.numeric(str_remove(lat, ",")),
         long = as.numeric(str_remove(long, ","))) %>%
  filter(!is.na(lat))

```

```{r create database summary, include = F}

data_sum_labels <- c(
  "Design type(s)",
  "Measurement type(s)",
  "Technology type(s)",
  "Factor type(s)",
  "Sample characteristics")

data_sum_values <- c(
  "Synthetic database - Marine ecology",
  "Taxonomic record",
  "Specialist identification - Environmental DNA - DNA Sequencing",
  "Scientific publication DOI",
  "Spatial coordinates - Lowest taxonomic unit - Substrate material type - Publication year"
)

data_sum_table <- data.frame(
  "Descriptor" = data_sum_labels,
  "Value" = data_sum_values
  )

```

## Abstract  

- How main measurement value is important (e.g. chlorophyll).  
- Why it is the choice measurement for that purpose.  
- How many records are included of main measurement and the spatiotemporal scope of their collection.  
- Primary methods used to collect and process data in source material.  
- Brief description of what source was used to find records.  
- Where to access the database.  
- What the database can be combined with and for which common uses.  

### Corresponding author  

Correspondence and requests for materials should be directed to \textbf{C. M. (email: c.c.mcmains@gmail.com)}.  

```{r data summary table, echo = F, fig.cap = "Summary description of synthetic database", fig.scap = "Database description", width = params$width}

kable(data_sum_table, "latex", booktabs = T, col.names = NULL) %>%
  kable_styling(latex_options = "scale_down")

```

## Background & Summary  
- Relevance of data. Why data exists. Compare to alternatives to metrics stored in data.  
- Caveats to using the data. Types of data used alongside for analyses/ context.  
- General trends in data and their biological origin.  
- Example of these trends.  
- Importance of outliers and other patterns in data to the users/collectors of it.  
- Example of program/project that relies on the data.  
- Alternative, less important origins for trends in the data.  
- Describe what data is present.  
- Describe where the data came from: organisations, projects, people.  
- Figure explaining data collection process.  
- Suggestion for pre-processing needed prior to using the data for various applications.  
- Anywhere else the data is offered.  
- Describe any ongoing updates or maintenance to that dataset. 
- Explain link between static set and that set.  

## Methods  
- Overview of methods used to collect the field data.  
- Explain where to find examples of each general method or a review paper describing various methods in detail.  
- Overview of most common methods to process the field data.  
- Brief comparison of these methods.  
- Mention of other methods possible to use but not included in the dataset and description of reason why they were excluded.  
- Describe how methods many be affected by different common scenarios that present in the field and lab.  
- Delineate sources of data compiled into the database.  
- Describe how data were accessed.  
- Describe how data was filtered for relevancy.  
- Describe how data was made to fit into a standardised data resource.  
- Describe how ongoing maintenance or updating would be performed.  

### Figures  

```{r buffer function, include = F}

addBuffer <- function(.num_vec, .buffer) {
  out_vec <- c()
    for (i in .num_vec) {
      if (i <= 0) {
        out <- i - .buffer
        } else {
          out <- i + .buffer
          }
      out_vec <- c(out_vec, out)
      }
  return(out_vec)
  }

```

```{r prep map data, include = F}

map_buffer <- 2
lat_lims <- c(min(spatial$lat), max(spatial$lat))
long_lims <- c(min(spatial$long), max(spatial$long))

map_bounds <- data.frame(lon = c(rep(long_lims[1],2),
                                 rep(long_lims[2], 2)),
                         lat = c(lat_lims[1],
                                 rep(lat_lims[2], 2),
                                 lat_lims[1])) %>%
  mutate_all(~addBuffer(., map_buffer)) %>%
  mutate_all(~round(., 1)) %>%
  mutate_all(~as.numeric(.))

map_data <- spatial %>%
  mutate(spot_id = ifelse(paper_id == 999, site, paper_id)) %>%
  select(paper_id, spot_id, lat, long) %>%
  mutate(lat = round(lat, 1),
         lon = round(long, 1)) %>%
  distinct() %>%
  left_join(select(papers, paper_id, environ)) %>%
  mutate(environ = str_replace_all(environ, "Benthic \\[Deep\\]", "Benthic"),
         environ = str_replace_all(environ, "Benthic; Benthic", "Benthic"),
         environ = str_replace_all(environ, "Beach; Benthic; Floating", "All"),
         environ = str_replace_all(environ, "Floating; Benthic", "Benthic; Floating"),
         environ = str_replace_all(environ, "Floating; Beach", "Beach; Floating"),
         environ = str_replace_all(environ, ";", " \\&")) %>%
  select(lat, lon, environ)

```

```{r map of records, echo = F, fig.cap = "Global distribution of sampling sites within publications describing organisms associated with AMD.", fig.scap = "Map of database sampling sites", fig.height = 4, fig.width = 5.5}

basemap(data = map_bounds, lat.interval = 30,
        land.col = 'grey95', land.border.col = "grey95", land.size = 0.1) +
  geom_point(data = map_data,
             mapping = aes(y = lat, x = lon, color = environ, fill = environ),
             shape = 21, alpha = 0.5, size = 1.5) +
  labs(x = "Longitude",
       y = "Latitude") +
  scale_fill_manual(name = "Collection\nenvironment",
                    values = RColorBrewer::brewer.pal(7, "Accent")) +
  scale_color_manual(name = "Collection\nenvironment",
                    values = RColorBrewer::brewer.pal(7, "Accent")) +
  theme(panel.background = element_rect(fill = "grey30"),
        panel.grid.major = element_line(color = "grey15", size = 0.5),
        panel.ontop = F,
        legend.title = element_text(face = "bold"),
        legend.key = element_rect(fill = "grey30", color = "black"))

```

```{r prep records data, include = F}

taxon_micro <- c("Bacteria", "Archaea", "Eukaryota", "Protozoa", "Metazoa",
                 "Fungi", "Gastrotricha", "Loricifera")
taxon_photo <- c("Plantae", "Chromista")
taxon_worm <- c("Annelida", "Nemertea", "Platyhelminthes", "Sipuncula", "Chaetognatha")
taxon_biofoul <- c("Bryozoa", "Cnidaria", "Echinodermata", "Entoprocta", "Porifera",
                   "Ascidiacea")
taxon_other <- c("Ctenophora", "Nematoda", "Priapulida", "Actinopterygii", "Elasmobranchii",
                 "Teleostei")

record_df <- df_orgs %>%
  mutate(taxon_group = ifelse(kingdom == "Animalia", phylum, kingdom),
         taxon_group = ifelse(taxon_group == "Chordata", class, taxon_group),
         taxon_group = factor(taxon_group),
         taxon_group = fct_collapse(taxon_group,
                                    Microbial = taxon_micro,
                                    Photosynthetic = taxon_photo,
                                    Worm = taxon_worm,
                                    Biofouling = taxon_biofoul,
                                    Other = taxon_other,
                                    Mollusk = "Mollusca",
                                    Arthropod = "Arthropoda"),
         taxon_group = fct_explicit_na(taxon_group, "Other")) %>%
  group_by(paper_id, taxon_group) %>%
  count() %>%
  left_join(select(papers, paper_id, year_pub)) %>%
  ungroup() %>%
  mutate(year_pub = as.numeric(ifelse(paper_id == "999", 2022, year_pub))) %>%
  group_by(year_pub, taxon_group) %>%
  summarise(taxon_count = sum(n)) %>%
  ungroup()

```

```{r yearly records, echo = F, fig.cap = "Yearly counts of publications and records of identified organisms on AMD in the scientific literature.", fig.scap = "Database publications & records by year", fig.width = 6.5, fig.height = 3.5}

record_df %>%
  filter(year_pub != 2022) %>%
  ggplot() +
  geom_bar(aes(x = year_pub, y = taxon_count, fill = taxon_group),
           color = "black", size = 0.6, stat = "identity", width = 0.5,
           na.rm = T, alpha = 0.7) +
  theme_minimal() +
  guides(fill = guide_legend(title = "Taxonomic\nGroup", nrow = 1)) +
  theme(legend.position = "top", 
        legend.title = element_text(face = "bold", size = rel(0.8)),
        legend.text = element_text(size = rel(0.8)),
        legend.key.size = unit(5, "points"),
        axis.text.y = element_text(size = rel(0.8)),
        axis.text.x = element_text(angle = 30, hjust = 1, size = rel(0.8)),
        axis.title = element_text(size = rel(0.9))) +
  scale_x_continuous(limits = c(1994.1, 2019.9), breaks = scales::breaks_width(1),
                     expand = expansion(0)) +
  labs(x = "Year Published",
       y = "Count of Organisms Recorded")

```

```{r diagram of process, include = F, width = params$width, fig.cap = "Diagram of the process used to gather and integrate publised records of organisms associated with AMD into the database.", fig.scap = "Database creation process diagram"}

diagram_loc 

```

## Data Records  
- Define the lowest level of record and what it describes (include def of identifier)  
- Describe how lowest records are linked through to other levels.  
- Describe highest level of record and why it collects the lower levels.  
- How metadata is linked to the dataset.  
- Any caveats to the above, like why multiple names of a species might be attached to a record.  
- Quality assurances for each record and how they were validated.  

## Technical Validation  
- How data was cleaned and prepared in a way that needs to be acknowledged in any analysis.  
- How data quality issues were addressed in the records that were lower quality but still met the minimum standards to be included.  
- Any conversions of preparations that may be confusion to a user at first.  
- Null or missing value signifiers.  

## Usage Notes  
- Where the data has been made available for use.  
- Suggest complementary datasets.  
- Suggest how to link the data through to those complementary sets.  
- Examples of how this type of data has been used in projects or publications in combination with other sources.  
- Common reasons that the dataset admin would be contacted.  
- How to contact the dataset admin.  
- Where to go for more information about the dataset.  

### Data Citation  
\emph{citation of dataset in stable repository}  

### Acknowledgements  
The records synthesised in this database were collected and described through the efforts of academic scientists and researchers, community scientists, and scientific professionals from around the world. We acknowledge their contributions to the body of knowledge compiled in this database and encourage further engagement with their published literature in our citation list. Where records from only one publication are used in continuing research, we recommend citing the publication directly or per the custodian's information. In the case where records from multiple sources were used from this database, this publication should be cited directly. This provenance can be determined using the publication identifier linked to every record in the database. For data originating from the Japanese Tsunami Marine Debris database, the work of Carlton et. al should be cited directly or in addition to this database.  

### Author Contributions  
C.M. designed the methodology, performed all steps of the compilation and preparation of this database, and wrote the manuscript.  C.L.H. and M.L.C. advised on the database synthesis. M.B. and C.L.H. provided significant assistance with and review of the manuscript. J.M. and M.L.C. also assisted with the manuscript review. Further details on author contributions can be found in Table 1 provided with the online version of this manuscript.  

### Additional Information  
Table 1 is only available in the online version of this paper.  

\textbf{Competing Interests}  
The authors declare no competing financial interests.  

\textbf{Appendices}  
Create a table of detailed description of each authors contribution per the publisher's requirements.  





